
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="author" content="MEEP Developers">
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-components-1.10.11">
    
    
      
        <title>Example Gallery - MEEP Documentation</title>
      
    
    
      
    
    
      <script src="../../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-2cd7d9ab0f.css">
      
      <link rel="stylesheet" href="../../assets/stylesheets/material-components-web.min.css">
      <link rel="stylesheet" href="../../assets/stylesheets/mdc-web.css">
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans:300,300i,400,400i,600,600i,700,700i,800,800i|Ubuntu+Mono">
        <style>body,input{font-family:"Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../meep_documentation.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js"></script>
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      
        <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink md-flex__cell--vmiddle">
        <a href="../.." title="MEEP Documentation" class="md-header-nav__button md-logo">
          
            <img src="../../assets/images/logo_white.png" width="36" height="36">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            MEEP Documentation -
            
              
                <span class="md-header-nav__parent">
                  Adjoint Module for Automated Design Optimization
                </span>
              
            
            Example Gallery
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/NanoComp/meep/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
      
    </div>
  </nav>
</header>
      
    
    <div class="md-container">
      
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        <i class="md-icon md-icon--home"></i>
      
    </div>
    MEEP Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/NanoComp/meep/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Adjoint Module" class="md-nav__link">
      Adjoint Module
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Adjoint Module for Automated Design Optimization
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Adjoint Module for Automated Design Optimization
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ReferenceManual/" title="Reference Manual" class="md-nav__link">
      Reference Manual
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Example Gallery
      </label>
    
    <a href="./" title="Example Gallery" class="md-nav__link md-nav__link--active">
      Example Gallery
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title md-nav__toc" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#full-automated-optimization-of-a-cross-router-device" title="Full automated optimization of a cross-router device" class="md-nav__link">
    Full automated optimization of a cross-router device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" title="---" class="md-nav__link">
    ---
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numerical-validation-of-adjoint-gradients" title="Numerical validation of adjoint gradients" class="md-nav__link">
    Numerical validation of adjoint gradients
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-the-calculation-serially-from-a-shell-script" title="Running the calculation serially from a shell script" class="md-nav__link">
    Running the calculation serially from a shell script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-calculation" title="Running the calculation" class="md-nav__link">
    Running the calculation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-calculation-in-parallel-using-paralleldesigntester" title="Running the calculation in parallel using ParallelDesignTester" class="md-nav__link">
    Running the calculation in parallel using ParallelDesignTester
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results" title="Results" class="md-nav__link">
    Results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Visualization/" title="Visualization" class="md-nav__link">
      Visualization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AdjointImplementationNotes/" title="Implementation Notes" class="md-nav__link">
      Implementation Notes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title md-nav__toc" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#full-automated-optimization-of-a-cross-router-device" title="Full automated optimization of a cross-router device" class="md-nav__link">
    Full automated optimization of a cross-router device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" title="---" class="md-nav__link">
    ---
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#numerical-validation-of-adjoint-gradients" title="Numerical validation of adjoint gradients" class="md-nav__link">
    Numerical validation of adjoint gradients
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-the-calculation-serially-from-a-shell-script" title="Running the calculation serially from a shell script" class="md-nav__link">
    Running the calculation serially from a shell script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-calculation" title="Running the calculation" class="md-nav__link">
    Running the calculation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-calculation-in-parallel-using-paralleldesigntester" title="Running the calculation in parallel using ParallelDesignTester" class="md-nav__link">
    Running the calculation in parallel using ParallelDesignTester
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results" title="Results" class="md-nav__link">
    Results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div id="article-content" class="md-content"> 
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/NanoComp/meep/blob/master/doc/docs/AdjointSolver/ExampleGallery.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                
                <!----------------------------------------------------->

<!- LaTeX macros used only for adjoint documentation  ->
<!----------------------------------------------------->
$$
   \newcommand{\vb}{\mathbf}
   \newcommand{\wt}{\widetilde}
   \newcommand{\mc}{\mathcal}
   \newcommand{\bmc}[1]{\boldsymbol{\mathcal{#1}}}
   \newcommand{\sup}[1]{^{\text{#1}}}
   \newcommand{\sups}[1]{^{\text{#1}}}
   \newcommand{\sub}[1]{_{\text{#1}}}
   \newcommand{\subs}[1]{_{\text{#1}}}
   \newcommand{\pard}[2]{\frac{\partial #1}{\partial #2}}
   \newcommand{\VMV}[3]{ \Big\langle #1 \Big| #2 \Big| #3 \Big\rangle}
$$

<style>
.superfences-tabs {
  display: flex;
  position: relative;
  flex-wrap: wrap;
}

.superfences-tabs .highlight {
  background: #ddd;
}

.superfences-tabs .superfences-content {
  display: none;
  order: 99;
  width: 100%;
}

.superfences-tabs label {
  width: auto;
  margin: 0 0.5em;
  padding: 0.25em;
  font-size: 120%;
  cursor: pointer;
}

.superfences-tabs input {
  position: absolute;
  opacity: 0;
}

.superfences-tabs input:nth-child(n+1) {
  color: #333333;
}

.superfences-tabs input:nth-child(n+1):checked + label {
    color: #FF5252;
}

.superfences-tabs input:nth-child(n+1):checked + label + .superfences-content {
    display: block;
}
</style>

<hr />
<h1 id="design-optimization-with-the-meep-adjoint-solver-gallery-of-worked-examples">Design optimization with the <span class=SC>meep</span> adjoint solver: Gallery of worked examples<a class="headerlink" href="#design-optimization-with-the-meep-adjoint-solver-gallery-of-worked-examples" title="Permanent link">&para;</a></h1>
<hr />
<blockquote>
<p><img alt="🔖" class="gemoji summary quirklist" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f516.png" title=":bookmark:" /> <strong><span class=SC>table of contents</span></strong></p>
<ul>
<li>
<p><a href="#full-automated-optimization-of-a-cross-router-device"><strong>Full automated optimization of a cross-router device</strong></a></p>
<p>An full example of a successful automated design automation in which <code>mp.adjoint</code>
automatically redesigns a photonic component to improve its performance by
several orders of magnitude with no human guidance whatsoever.</p>
</li>
<li>
<p><a href="#numerical-validation-of-adjoint-gradients"><strong>Numerical validation of adjoint gradients</strong></a></p>
<p>A warm-up validation in which we test the accuracy of objective-function derivatives
computed by <code>mp.adjoint</code> against known results and finite-difference derivatives
for a simple toy model.</p>
</li>
</ul>
</blockquote>
<h2 id="full-automated-optimization-of-a-cross-router-device"><strong>Full automated optimization of a cross-router device</strong><a class="headerlink" href="#full-automated-optimization-of-a-cross-router-device" title="Permanent link">&para;</a></h2>
<p>In this example, <code>meep.adjoint</code> automatically designs the 
central section of a <a href="./#full-automated-optimization-of-a-cross-router-device">four-way router</a>
to achieve near-perfect routing of power from the <code>west</code> input
port to the <code>north</code> output port.</p>
<div class="highlight"><pre><span></span>   <span class="nb">cd</span> <span class="si">${</span><span class="nv">MEEP_INSTALLATION</span><span class="si">}</span>/python/examples/adjoint_optimization
   python CrossRouter.py --verbose --visualize --optimize
</pre></div>

<blockquote>
<p><img alt="🔖" class="gemoji" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f516.png" title=":bookmark:" /> <strong>Iteration Zero: Initial objective-function value <span><span class="MathJax_Preview">f_0 = 8.5\times 10^{-4}</span><script type="math/tex">f_0 = 8.5\times 10^{-4}</script></span></strong></p>
</blockquote>
<p><br></p>
<table>
<thead>
<tr>
<th align="center">Geometry</th>
<th align="center">Forward fields</th>
<th align="center">Adjoint derivative <span><span class="MathJax_Preview">\partial f /\partial\epsilon</span><script type="math/tex">\partial f /\partial\epsilon</script></span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img alt="zoomify" src="../images/RouterGeometry_Iter0.png" /></td>
<td align="center"><img alt="zoomify" src="../images/RouterForward_Iter0.png" /></td>
<td align="center"><img alt="zoomify" src="../images/RouterDerivative_Iter0.png" /></td>
</tr>
</tbody>
</table>
<blockquote>
<p><img alt="🔖" class="gemoji" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f516.png" title=":bookmark:" /> <strong>Iteration One: Objective-function value <span><span class="MathJax_Preview">f_1 = 3.8\times 10^{-1}</span><script type="math/tex">f_1 = 3.8\times 10^{-1}</script></span></strong></p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Geometry</th>
<th align="center">Forward fields</th>
<th align="center">Adjoint derivative <span><span class="MathJax_Preview">\partial f /\partial\epsilon</span><script type="math/tex">\partial f /\partial\epsilon</script></span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img alt="zoomify" src="../images/RouterGeometry_Iter1.png" /></td>
<td align="center"><img alt="zoomify" src="../images/RouterForward_Iter1.png" /></td>
<td align="center"><img alt="zoomify" src="../images/RouterDerivative_Iter1.png" /></td>
</tr>
</tbody>
</table>
<blockquote>
<p><img alt="🔖" class="gemoji" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f516.png" title=":bookmark:" /> <strong>After 50 Iterations: Objective-function value <span><span class="MathJax_Preview">f_1 = 0.9605</span><script type="math/tex">f_1 = 0.9605</script></span></strong></p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Geometry</th>
<th align="center">Forward fields</th>
<th align="center">Adjoint derivative <span><span class="MathJax_Preview">\partial f /\partial\epsilon</span><script type="math/tex">\partial f /\partial\epsilon</script></span></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img alt="zoomify" src="../images/RouterGeometry_Final.png" /></td>
<td align="center"><img alt="zoomify" src="../images/RouterForward_Final.png" /></td>
<td align="center"><img alt="zoomify" src="../images/RouterDerivative_Final.png" /></td>
</tr>
</tbody>
</table>
<blockquote>
<p><img alt="🔖" class="gemoji" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f516.png" title=":bookmark:" /> <strong>Objective-function evolution by iteration</strong>
  <img alt="zoomify" src="../images/RouterObjectiveByIter.png" /></p>
</blockquote>
<h2 id="-">---<a class="headerlink" href="#-" title="Permanent link">&para;</a></h2>
<h2 id="numerical-validation-of-adjoint-gradients">Numerical validation of adjoint gradients<a class="headerlink" href="#numerical-validation-of-adjoint-gradients" title="Permanent link">&para;</a></h2>
<p>As discussed in the <a href="../ReferenceManual/">Reference Manual</a>,
the <code>OptimizationProblem</code> base class offers command-line options
for estimating objective-function derivatives with respect
to individual design variables---that is, individual components
of the objective-function gradient vector---by numerical finite-differencing. 
This provides a useful check on the accuracy of the
gradient computed via the adjoint method. In this example
we'll apply this technique to the simple
<a href="../Overview/#the-holey-waveguide">holey waveguide</a> geometry discussed
in the [Overview][Overview], involving a circular hole 
in an otherwise perfect section of a slab waveguide of
permittivity <span><span class="MathJax_Preview">\epsilon\sups{wvg}</span><script type="math/tex">\epsilon\sups{wvg}</script></span>.
For this problem, the design region is the area of the hole,
and we will consider a particularly simple basis consisting of
the single basis function <span><span class="MathJax_Preview">\{b_0(\vb x)\equiv 1\}</span><script type="math/tex">\{b_0(\vb x)\equiv 1\}</script></span>, so that
our sole design variable <span><span class="MathJax_Preview">\beta_0</span><script type="math/tex">\beta_0</script></span> is just the constant permittivity$
<span><span class="MathJax_Preview">\epsilon\sups{hole}</span><script type="math/tex">\epsilon\sups{hole}</script></span> of the hole region; the design problem is
to tweak <span><span class="MathJax_Preview">\epsilon\sups{hole}</span><script type="math/tex">\epsilon\sups{hole}</script></span> 
to maximize output power flux (flux through the port labeled 'east') 
for fixed input flux from by the eigenmode source2.</p>
<p>The advantage of this as a validating sanity-check for
adjoint calculations is the simple dependence 
of the objective on the design variable:
clearly, transmission through the waveguides can't
be better than perfect, which is what it is
when $\epsilon\sups{hole}\equiv \epsilon\sups{wvg}
and there \textit{is} no hole, so 
the function <span><span class="MathJax_Preview">f(\epsilon\sup{hole})</span><script type="math/tex">f(\epsilon\sup{hole})</script></span> must
be peaked at <span><span class="MathJax_Preview">\epsilon\sup{wvg}</span><script type="math/tex">\epsilon\sup{wvg}</script></span> and its
derivative vanishes there. This gives one
test on the correctness of an adjoint implementation,
and we get others by looking at the derivative
at other points on the curve, with reference values
be estimated via finite-differencing.</p>
<p>Thus, for a set of 24 <span><span class="MathJax_Preview">\epsilon^\subs{hole}</span><script type="math/tex">\epsilon^\subs{hole}</script></span> values
ranging from 1 to <span><span class="MathJax_Preview">2\epsilon^\sup{wvg}</span><script type="math/tex">2\epsilon^\sup{wvg}</script></span> we will
compute the objective function and its adjoint-based 
and finite-difference derivatives with respect to
<span><span class="MathJax_Preview">\epsilon\sups{hole}</span><script type="math/tex">\epsilon\sups{hole}</script></span>.</p>
<h3 id="running-the-calculation-serially-from-a-shell-script">Running the calculation serially from a shell script<a class="headerlink" href="#running-the-calculation-serially-from-a-shell-script" title="Permanent link">&para;</a></h3>
<p>The individual calculations may be performed by executing the
[<code>HoleyWaveguide.py</code>][<code>HoleyWaveyguide.py</code>] script from the
shell with command-line options, i.e.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

python HoleyWaveguide.py <span class="si">${</span><span class="nv">COMMON</span><span class="si">}</span> --beta <span class="m">0</span>  <span class="m">1</span>.0 --filebase B1P0
python HoleyWaveguide.py <span class="si">${</span><span class="nv">COMMON</span><span class="si">}</span> --beta <span class="m">0</span>  <span class="m">1</span>.5 --filebase B1P5
python HoleyWaveguide.py <span class="si">${</span><span class="nv">COMMON</span><span class="si">}</span> --beta <span class="m">0</span>  <span class="m">2</span>.0 --filebase B120
...
python HoleyWaveguide.py <span class="si">${</span><span class="nv">COMMON</span><span class="si">}</span> --beta <span class="m">0</span> <span class="m">12</span>.0 --filebase BW12P0
</pre></div>

<p>Note that the only options that vary from case to case
are <code>--beta 0 xx</code>, setting distinct values for the design
variable <span><span class="MathJax_Preview">\beta_0\equiv \epsilon\sups{hole}</span><script type="math/tex">\beta_0\equiv \epsilon\sups{hole}</script></span>,
and <code>--filebase,</code> giving different names to output
files so they don't overwrite one another.
The options in common to all cases are:</p>
<div class="highlight"><pre><span></span><span class="c1">### Running the calculation serially from Python</span>

The effect of running the shell <span class="nb">command</span>
<span class="sb">`</span>% python HoleyWaveguide.py OPTIONS<span class="sb">`</span>
can be reproduced from a python script or console
by creating an instance of <span class="sb">`</span>HoleyWaveguide<span class="sb">`</span>
and calling its <span class="sb">`</span>run<span class="o">()</span><span class="sb">`</span> method.
In this <span class="k">case</span>, the command-line options OPTIONS
should be passed <span class="o">(</span>as a single string separated by spaces<span class="o">)</span>
to the optional <span class="sb">`</span>cmdline<span class="sb">`</span> parameter of the <span class="sb">`</span>HoleyWaveguide<span class="sb">`</span>
constructor, <span class="k">while</span> <span class="sb">`</span>run<span class="o">()</span><span class="sb">`</span> takes no arguments:

<span class="sb">```</span>py3
import numpy as np

<span class="c1"># generate command lines</span>
<span class="nv">bs</span> <span class="o">=</span> np.linspace<span class="o">(</span><span class="m">1</span>.0,12.0,23<span class="o">)</span>
<span class="nv">args</span> <span class="o">=</span> <span class="s2">&quot; --eval_gradient --fd_order 2 --fd_index 0 &quot;</span>
<span class="nv">cmdlines</span> <span class="o">=</span> <span class="o">[</span> args + <span class="s1">&#39;--beta 0 {} --filebase b{}&#39;</span>.format<span class="o">(</span>b,b<span class="o">)</span> <span class="k">for</span> b in bs <span class="o">]</span>

<span class="c1"># run calculations </span>
<span class="k">for</span> cmdline in cmdlines:
    <span class="nv">HW</span><span class="o">=</span>HoleyWaveguide<span class="o">(</span><span class="nv">cmdline</span><span class="o">=</span>cmdline<span class="o">)</span>    
    HW.run<span class="o">()</span>
</pre></div>

<h3 id="running-the-calculation">Running the calculation<a class="headerlink" href="#running-the-calculation" title="Permanent link">&para;</a></h3>
<p>Here's how the </p>
<h3 id="running-the-calculation-in-parallel-using-paralleldesigntester">Running the calculation in parallel using <code>ParallelDesignTester</code><a class="headerlink" href="#running-the-calculation-in-parallel-using-paralleldesigntester" title="Permanent link">&para;</a></h3>
<p>Although these calculations aren't particularly time-consuming,
in a multiprocessor environment
we can make them go <em>really</em> fast by using the <code>ParallelDesignTester</code>
utility distributed with <code>meep.adjoint</code>. As described in the
[Reference Manual][ParallelDesignTester], this is a simple
tool provided by <code>meep.adjoint parallel batch processing of jobs 
like the one considered here, which has the advantage of
presenting as a completely transparent drop-in replacement
for your existing serial loop: 
the</code>entirety<code>of the rejiggering required to parallelize
your batch is to replace the</code>for cmdline in cmdlines` loop 
above with the single line</p>
<div class="highlight"><pre><span></span><span class="n">ParallelDesignTester</span><span class="p">(</span><span class="s1">&#39;HoleyWaveguide&#39;</span><span class="p">,</span><span class="n">cmdlines</span><span class="p">)</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>

<p>This will launch a pool of <span><span class="MathJax_Preview">N</span><script type="math/tex">N</script></span> server processes to whittle
its way in parallel through your batch; for each string
in the <code>cmdlines</code> list, one or another server will
instantiate a <code>HoleyWaveguide</code> (or any other class you
specify) with those command lines, then call its <code>run()</code>
method. </p>
<h3 id="results">Results<a class="headerlink" href="#results" title="Permanent link">&para;</a></h3>
<p>Whether executed serially or in parallel, each of the 23 jobs
produces text-based output files named e.g. <code>b13.out</code>, <code>b13.digest,</code>
and <code>b13.legend</code>, where <code>b13</code> is the job-dependent
label assigned the <code>filebase</code> option. The <code>out</code>
file uses a compressed format in which all data 
(objective-function values, adjoint gradient values, 
and finite-difference derivatives) for a specific design
point (in this case, that means a specific value of 
<span><span class="MathJax_Preview">\beta_0\equiv \epsilon\sups{hole}</span><script type="math/tex">\beta_0\equiv \epsilon\sups{hole}</script></span>) appear on a single
line of the file with labels to indicate the design point;
this is indended for plotting vs. <span><span class="MathJax_Preview">\beta_0</span><script type="math/tex">\beta_0</script></span> or other
post-processing. The <code>digest</code> file reports the same
data in a more human-readable format.  The <code>legend</code>
file contains information helping to interpret the content
of the other files.</p>
<p>!!! note "Working directories in <code>ParallelDesignTester</code> runs
    <code>ParallelDesignTester</code> creates and changes to a new 
    timestamped working directory for each pool of parallel
    batch jobs; look for your output files in
    subdirectory called something like <code>HoleyWaveguide_0323.022256,</code></p>
<p>For the case at hand, we want to <strong>(a)</strong> concatenate all of the
<code>.out</code> files into an omnibus data file, <strong>(b)</strong> sort by the 
design-variable values reported on specific columns, then
<strong>&copy;</strong> plot various data quantities (e.g. objective-function 
value, adjoint gradient components, and finite-difference derivatives, 
each of which appear in their own specific columns)
versus design variable.</p>
<p>![HoleyWaveguideAdjointVsFDResults][HoleyWaveguide_AdjointVsFD.png]</p>
<p>We see that <span><span class="MathJax_Preview">\epsilon\sup{hole}</span><script type="math/tex">\epsilon\sup{hole}</script></span> derivatives computed by
adjoints agree well with numerical finite-difference data.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../ReferenceManual/" title="Reference Manual" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Reference Manual
              </span>
            </div>
          </a>
        
        
          <a href="../Visualization/" title="Visualization" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Visualization
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://yakworks.github.io/mkdocs-material-components/" title="Material Components for MkDocs">
          Material Components for MkDocs</a>
      </div>
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-68832431b5.js"></script>
      
      
      <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
      <script>window.mdc.autoInit()</script>
      <script src="../../assets/javascripts/headroom.min.js"></script>
      <script src="../../assets/javascripts/jQuery.headroom.min.js"></script>
      <script src="../../assets/javascripts/jq-mdc-web.js"></script>
      <script src="https://cdn.jsdelivr.net/jquery.loadingoverlay/latest/loadingoverlay.min.js"></script>
      <script>app.initialize({version:"0.16.3",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
    
  </body>
</html>