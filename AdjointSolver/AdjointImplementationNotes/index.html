
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="author" content="MEEP Developers">
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-components-1.10.11">
    
    
      
        <title>Implementation Notes - MEEP Documentation</title>
      
    
    
      
    
    
      <script src="../../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-2cd7d9ab0f.css">
      
      <link rel="stylesheet" href="../../assets/stylesheets/material-components-web.min.css">
      <link rel="stylesheet" href="../../assets/stylesheets/mdc-web.css">
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans:300,300i,400,400i,600,600i,700,700i,800,800i|Ubuntu+Mono">
        <style>body,input{font-family:"Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../meep_documentation.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js"></script>
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      
        <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink md-flex__cell--vmiddle">
        <a href="../.." title="MEEP Documentation" class="md-header-nav__button md-logo">
          
            <img src="../../assets/images/logo_white.png" width="36" height="36">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            MEEP Documentation -
            
              
                <span class="md-header-nav__parent">
                  Adjoint Module for Automated Design Optimization
                </span>
              
            
            Implementation Notes
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/NanoComp/meep/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
      
    </div>
  </nav>
</header>
      
    
    <div class="md-container">
      
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        <i class="md-icon md-icon--home"></i>
      
    </div>
    MEEP Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/NanoComp/meep/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Adjoint Module" class="md-nav__link">
      Adjoint Module
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Adjoint Module for Automated Design Optimization
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Adjoint Module for Automated Design Optimization
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ReferenceManual/" title="Reference Manual" class="md-nav__link">
      Reference Manual
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ExampleGallery/" title="Example Gallery" class="md-nav__link">
      Example Gallery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Visualization/" title="Visualization" class="md-nav__link">
      Visualization
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Implementation Notes
      </label>
    
    <a href="./" title="Implementation Notes" class="md-nav__link md-nav__link--active">
      Implementation Notes
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title md-nav__toc" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#toy-problem" title="Toy problem" class="md-nav__link">
    Toy problem
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#permittivity-derivative-by-finite-differencing" title="Permittivity derivative by finite-differencing" class="md-nav__link">
    Permittivity derivative by finite-differencing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permittivity-derivative-from-effective-sources" title="Permittivity derivative from effective sources" class="md-nav__link">
    Permittivity derivative from effective sources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#digression-configuring-time-domain-sources-for-desired-frequency-domain-fields-in-meep" title="Digression: Configuring time-domain sources for desired frequency-domain fields in meep" class="md-nav__link">
    Digression: Configuring time-domain sources for desired frequency-domain fields in meep
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invoking-reciprocity" title="Invoking reciprocity" class="md-nav__link">
    Invoking reciprocity
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#differentiating-more-complicated-functions-of-field-components" title="Differentiating more complicated functions of field components" class="md-nav__link">
    Differentiating more complicated functions of field components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#e-field-energy-in-region" title="E-field energy in region" class="md-nav__link">
    E-field energy in region
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poynting-flux" title="Poynting flux" class="md-nav__link">
    Poynting flux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mode-coefficient" title="Mode coefficient" class="md-nav__link">
    Mode coefficient
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title md-nav__toc" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#toy-problem" title="Toy problem" class="md-nav__link">
    Toy problem
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#permittivity-derivative-by-finite-differencing" title="Permittivity derivative by finite-differencing" class="md-nav__link">
    Permittivity derivative by finite-differencing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permittivity-derivative-from-effective-sources" title="Permittivity derivative from effective sources" class="md-nav__link">
    Permittivity derivative from effective sources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#digression-configuring-time-domain-sources-for-desired-frequency-domain-fields-in-meep" title="Digression: Configuring time-domain sources for desired frequency-domain fields in meep" class="md-nav__link">
    Digression: Configuring time-domain sources for desired frequency-domain fields in meep
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invoking-reciprocity" title="Invoking reciprocity" class="md-nav__link">
    Invoking reciprocity
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#differentiating-more-complicated-functions-of-field-components" title="Differentiating more complicated functions of field components" class="md-nav__link">
    Differentiating more complicated functions of field components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#e-field-energy-in-region" title="E-field energy in region" class="md-nav__link">
    E-field energy in region
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poynting-flux" title="Poynting flux" class="md-nav__link">
    Poynting flux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mode-coefficient" title="Mode coefficient" class="md-nav__link">
    Mode coefficient
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div id="article-content" class="md-content"> 
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/NanoComp/meep/blob/master/doc/docs/AdjointSolver/AdjointImplementationNotes.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                
                <!----------------------------------------------------->

<!- LaTeX macros used only for adjoint documentation  ->
<!----------------------------------------------------->
$$
   \newcommand{\vb}{\mathbf}
   \newcommand{\wt}{\widetilde}
   \newcommand{\mc}{\mathcal}
   \newcommand{\bmc}[1]{\boldsymbol{\mathcal{#1}}}
   \newcommand{\sup}[1]{^{\text{#1}}}
   \newcommand{\sups}[1]{^{\text{#1}}}
   \newcommand{\sub}[1]{_{\text{#1}}}
   \newcommand{\subs}[1]{_{\text{#1}}}
   \newcommand{\pard}[2]{\frac{\partial #1}{\partial #2}}
   \newcommand{\VMV}[3]{ \Big\langle #1 \Big| #2 \Big| #3 \Big\rangle}
$$

<style>
.superfences-tabs {
  display: flex;
  position: relative;
  flex-wrap: wrap;
}

.superfences-tabs .highlight {
  background: #ddd;
}

.superfences-tabs .superfences-content {
  display: none;
  order: 99;
  width: 100%;
}

.superfences-tabs label {
  width: auto;
  margin: 0 0.5em;
  padding: 0.25em;
  font-size: 120%;
  cursor: pointer;
}

.superfences-tabs input {
  position: absolute;
  opacity: 0;
}

.superfences-tabs input:nth-child(n+1) {
  color: #333333;
}

.superfences-tabs input:nth-child(n+1):checked + label {
    color: #FF5252;
}

.superfences-tabs input:nth-child(n+1):checked + label + .superfences-content {
    display: block;
}
</style>

<h1 id="adjoint-based-optimization-in-meep-implementation-notes">Adjoint-based optimization in <span class="SC">meep</span>: Implementation Notes<a class="headerlink" href="#adjoint-based-optimization-in-meep-implementation-notes" title="Permanent link">&para;</a></h1>
<p>These notes are intended as something of a companion to the
<a href="../Overview/">user's manual and tutorial documentation for adjoint-based
optimization in <span class="SC">meep</span></a>; 
whereas the goal of those pages is to document the user interface
and explain how to <em>use</em> the solver for practical problems,
our focus here will be what's going on beneath the hood---how
the solver actually <em>works.</em></p>
<p>Actually, as will be clear to anyone who has ever reviewed the
fundamentals of
<a href="https://en.wikipedia.org/wiki/Adjoint_state_method">adjoint sensitivity analysis</a>,
the theoretical basis of the method and the derivation of its key
formulas are almost trivially straightforward, with the only
potential source of difficulty being how to massage the mechanics
of the procedure into a <span class="SC">meep</span>-friendly form.</p>
<h2 id="toy-problem">Toy problem<a class="headerlink" href="#toy-problem" title="Permanent link">&para;</a></h2>
<p>Ultimately we will want to use adjoint methods to differentiate
complex objective functions---involving quantities such as
Poynting fluxes and mode-expansion coefficients---with respect
to various different types of parameters describing material geometries.
However, before tackling the problem in that full generality,
it's useful to build up to it by starting with a simple toy problem
and adding complications one at a time. Thus we consider a
simple waveguide geometry, excited by a point source at
<span><span class="MathJax_Preview">\vb{x}\sup{src}</span><script type="math/tex">\vb{x}\sup{src}</script></span>, and define our objective function to be
simply the frequency-domain electric-field amplitude at
a point <span><span class="MathJax_Preview">\vb{x}\sup{obj}</span><script type="math/tex">\vb{x}\sup{obj}</script></span>; we will compute the derivative
of this objective function with respect to the permittivity
<span><span class="MathJax_Preview">\epsilon\sup{des}</span><script type="math/tex">\epsilon\sup{des}</script></span>
in a small "design region" <span><span class="MathJax_Preview">\mc{V}\sup{des}</span><script type="math/tex">\mc{V}\sup{des}</script></span>
centered at a third point <span><span class="MathJax_Preview">\vb{x}\sup{des}</span><script type="math/tex">\vb{x}\sup{des}</script></span>.</p>
<p><img alt="AdjointToyGeometry1" src="../images/AdjointToyGeometry1.png" /></p>
<h3 id="permittivity-derivative-by-finite-differencing">Permittivity derivative by finite-differencing<a class="headerlink" href="#permittivity-derivative-by-finite-differencing" title="Permanent link">&para;</a></h3>
<p>An obvious brute-force way to get at this is simply
to do two <span class=SC>meep</span> calculations, with <span><span class="MathJax_Preview">\epsilon\sup{des}</span><script type="math/tex">\epsilon\sup{des}</script></span>
augmented by a small finite amount <span><span class="MathJax_Preview">\Delta\epsilon</span><script type="math/tex">\Delta\epsilon</script></span> on the
second run, then compute the difference between the frequency-domain
electric fields at <span><span class="MathJax_Preview">\vb{x}\sup{obj}</span><script type="math/tex">\vb{x}\sup{obj}</script></span> and divide
by <span><span class="MathJax_Preview">\Delta\epsilon</span><script type="math/tex">\Delta\epsilon</script></span> to estimate the derivative.
Here are plots of the unperturbed field and the field perturbation
(difference between perturbed and unperturbed field):</p>
<ul>
<li><span><span class="MathJax_Preview">\wt{E_{z0}}(\omega_0, \vb{x})</span><script type="math/tex">\wt{E_{z0}}(\omega_0, \vb{x})</script></span> (unperturbed):</li>
</ul>
<p><img alt="Unperturbed field" src="../images/AdjointToyEz0.png" /></p>
<ul>
<li><span><span class="MathJax_Preview">\Delta {\wt E_z}(\omega_0, \vb{x})</span><script type="math/tex">\Delta {\wt E_z}(\omega_0, \vb{x})</script></span> (perturbed-unperturbed):
<img alt="Perturbation field" src="../images/AdjointToydEz_FD.png" /></li>
</ul>
<p>(Here and below we use the tilde sign (<span><span class="MathJax_Preview">\sim</span><script type="math/tex">\sim</script></span>) to indicate frequency-domain
fields and sources.)</p>
<h3 id="permittivity-derivative-from-effective-sources">Permittivity derivative from effective sources<a class="headerlink" href="#permittivity-derivative-from-effective-sources" title="Permanent link">&para;</a></h3>
<p>One way to think about the effect of a localized permittivity
bump goes like this: Increasing the permittivity in some localized
region of a material body corresponds to increasing the
polarizability in that region---that is, the ease with which
positive and negative charges in the material, ordinarily bound
so tightly together that they neutralize each other as sources,
can be induced by applied electric fields to separate ("polarize"),
whereupon they cease to cancel each other and act as effective
sources contributing to electromagnetic fields.
Of course, if there were no electric field in the material,
then we could increase its polarizability as much as we pleased
without producing any sources---zero times a bigger
coefficient being still zero---but here there <em>is</em> a nonzero
electric field throughout our geometry, due to the point source
in the unperturbed problem, which means that the effect of bumping the
permittivity of the design region may be approximated by
adding new <em>sources</em> in that region, with strength
proportional to <span><span class="MathJax_Preview">\Delta\epsilon</span><script type="math/tex">\Delta\epsilon</script></span> and to the unperturbed electric field.
More specifically, in a frequency-domain problem involving time-harmonic
fields and sources with angular frequency <span><span class="MathJax_Preview">\omega</span><script type="math/tex">\omega</script></span> (time dependence
<span><span class="MathJax_Preview">\propto e^{-i\omega t}</span><script type="math/tex">\propto e^{-i\omega t}</script></span>), the following perturbations are
equivalent:
$$
\begin{array}{ccc}
 \left(\begin{array}{c}
 \text{a permittivity shift of } \Delta\epsilon \
 \text{over a small region } \mc{V} \text{ in which} \
 \text{the electric field is } \wt{\vb{E}}
 \end{array}\right)
 &amp;\Longleftrightarrow &amp;
  \left(\begin{array}{c}
   \text{a localized electric current } \
   \text{flowing in }\mc{V} \text{ with amplitude } \
   \Delta\wt{\vb J}=-i\omega\Delta\epsilon \wt{\vb{E}}
  \end{array}\right)
\end{array}
$$</p>
<p><img alt="AdjointToyGeometry1" src="../images/AdjointToyGeometry2.png" /> </p>
<p>Superposing this effective source with the original point source
at <span><span class="MathJax_Preview">\vb{x}\sup{src}</span><script type="math/tex">\vb{x}\sup{src}</script></span> yields a source configuration that,
acting on the <em>unperturbed</em> geometry, produces the same fields
as the point source alone acting on the <em>perturbed</em> geometry.</p>
<p>Alternatively, by exploiting the linearity of Maxwell's equations
(and assuming we have linear media!) we could just as easily
remove the original point source and compute the fields of
<span><span class="MathJax_Preview">\wt{\Delta \vb{J}}</span><script type="math/tex">\wt{\Delta \vb{J}}</script></span> <em>alone</em>, which, upon dividing through by
<span><span class="MathJax_Preview">\Delta\epsilon</span><script type="math/tex">\Delta\epsilon</script></span>, give just the derivatives of field components
with respect to <span><span class="MathJax_Preview">\epsilon</span><script type="math/tex">\epsilon</script></span>. In other words,
$$ \pard{ \wt{\vb E} (\vb x\sup{obj}) }{\epsilon\sup{des}}
   \equiv
   \left(\begin{array}{cc}
   \text{electric field at }\vb{x}\sup{obj} \text{ due to }\
   \text{current at }\vb{x}\sup{des}\text{ with amplitude}\
   \wt{\Delta \vb J}=-i\omega\wt{\vb{E}}(\vb{x}\sup{obj})
   \end{array}\right)
   \tag{1a}
$$
Analogous reasoning yields a prescription for magnetic-field derivatives:
$$ \pard{\wt{\vb{H}}(\vb x\sup{obj})}{\epsilon\sup{des}}
   \equiv
   \left(
   \begin{array}{cc}
   \text{magnetic field at }\vb{x}\sup{obj} \text{ due to }\
   \text{current at }\vb{x}\sup{des}\text{ with amplitude}\
   \wt{\Delta \vb J}=-i\omega\wt{\vb{E}}(\vb{x}\sup{obj})
   \end{array}
   \right)
   \tag{1b}
$$</p>
<h3 id="digression-configuring-time-domain-sources-for-desired-frequency-domain-fields-in-meep">Digression: Configuring time-domain sources for desired frequency-domain fields in <span class=SC>meep</span><a class="headerlink" href="#digression-configuring-time-domain-sources-for-desired-frequency-domain-fields-in-meep" title="Permanent link">&para;</a></h3>
<p>In frequency-domain electromagnetism we usually consider 
a time-harmonic source distribution of the form
$$
   \vb{J}\sup{monochromatic}(t,\vb{x})\equiv 
   \wt{\vb{J}}(\vb x)e^{-i\omega t}
$$
and we ask for the time-harmonic electric field distribution
radiated by this distribution:
$$
  \vb{E}\sup{monochromatic}(t,\vb{x})\equiv 
  \wt{\vb{E}}(\vb x)e^{-i\omega t}
$$
where <span><span class="MathJax_Preview">\sim</span><script type="math/tex">\sim</script></span> indicates frequency-domain amplitudes.
A typical frequency-domain solver might input
<span><span class="MathJax_Preview">\wt{\vb J}(\vb x)</span><script type="math/tex">\wt{\vb J}(\vb x)</script></span> and output
<span><span class="MathJax_Preview">\wt{\vb E}(\vb x)</span><script type="math/tex">\wt{\vb E}(\vb x)</script></span>:
$$ \wt{\vb J}(\vb x)
   \quad \Longrightarrow \quad
   \begin{array}{|c|}\hline\
   \text{    frequency-domain solver    }\
   \\hline\end{array}
   \quad \Longrightarrow \quad
   \wt{\vb E}(\vb x)
$$</p>
<p>On the other hand, when using <span class=SC>meep</span> to compute
the fields produced by a given spatial source distribution,
we typically construct a time-domain source of the form
<span><span class="MathJax_Preview"><span><span class="MathJax_Preview">\vb{J}\sup{meep}(t,\vb{x})=G(t)\wt{\vb{J}}(\vb x)</span><script type="math/tex">\vb{J}\sup{meep}(t,\vb{x})=G(t)\wt{\vb{J}}(\vb x)</script></span></span><script type="math/tex"><span><span class="MathJax_Preview">\vb{J}\sup{meep}(t,\vb{x})=G(t)\wt{\vb{J}}(\vb x)</span><script type="math/tex">\vb{J}\sup{meep}(t,\vb{x})=G(t)\wt{\vb{J}}(\vb x)</script></span></script></span>
where <span><span class="MathJax_Preview">G(t)</span><script type="math/tex">G(t)</script></span> is a Gaussian temporal envelope.
More specifically, for <span class=SC>meep</span>'s <code>GaussianSrc</code> with
center frequency <span><span class="MathJax_Preview">\omega_0=2\pi f_0</span><script type="math/tex">\omega_0=2\pi f_0</script></span>,
frequency width <span><span class="MathJax_Preview">\Delta \omega =2\pi \Delta f</span><script type="math/tex">\Delta \omega =2\pi \Delta f</script></span>, and
peak time <span><span class="MathJax_Preview">t_0</span><script type="math/tex">t_0</script></span>, we have
$$ G(t) = e^{-i\omega_0(t-t_0) - \frac{1}{2}[\Delta f(t-t_0)]^2}.$$
The Fourier transform of this is
$$
   \wt G(\omega) \equiv \frac{1}{\sqrt{2\pi}}
   \int e^{i\omega t}G(t)\,dt =
   \frac{1}{\Delta f}
   e^{i\omega t_0 -\frac{(\omega-\omega_0)^2}{2\Delta f^2}}.
$$
The <span class=SC>meep</span> version of the above
input/output diagram looks like
$$ G(t)\wt{\vb J}(\vb x)
   \quad \Longrightarrow \quad
   \begin{array}{|c|}\hline\
   \text{ MEEP }\
   \text{    (timestepping + DFT)    } \
   \\hline\end{array}
   \quad \Longrightarrow \quad
   \wt{G}(\omega)\wt{\vb E}(\vb x)
$$</p>
<p>The upshot is that the frequency-domain fields obtained from a
<span class=SC>meep</span> run with a Gaussian source
come out multiplied by a factor of <span><span class="MathJax_Preview">\wt{G}(\omega)</span><script type="math/tex">\wt{G}(\omega)</script></span> that should
be divided out to yield the desired frequency-domain quantities.</p>
<h2 id="invoking-reciprocity">Invoking reciprocity<a class="headerlink" href="#invoking-reciprocity" title="Permanent link">&para;</a></h2>
<p>It is convenient to describe the process described above
in the language of frequency-domain Green's functions, which
express the fields radiated by monochromatic source distributions
as spatial convolutions:
$$ \wt{E_i}(\omega, \vb{x}\sup{dest}) =
   \int
   \mc{G}\sup{EE}<em ij="ij">{ij}(\omega, \vb{x}\sup{dest}, \vb{x}\sup{src}) 
   \wt{J_j}(\omega, \vb{x}\sup{src})
  \,d\vb{x}\sup{src}
$$
with <span><span class="MathJax_Preview">\bmc{G}\sup{EE}</span><script type="math/tex">\bmc{G}\sup{EE}</script></span> the
electric-electric dyadic Green's function of the material geometry
(giving the electric field produced by a unit-strength electric 
current).
In this language, the effective-source representation
of the permittivity derivative reads
$$ \pard{\wt{E}_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}
   =
   \int \mc{G}\sup{EE}</em>(\vb{x}\sup{obj}, \vb{x}\sup{des})
   \left[-i\omega \wt{E}<em ij="ij">j(\vb{x}\sup{des})\right]
   \,d\vb{x}\sup{des}
$$
It is convenient to think of the RHS here as a double convolution
of two vector-valued functions with the <span><span class="MathJax_Preview">\bmc{G}\sup{EE}</span><script type="math/tex">\bmc{G}\sup{EE}</script></span> kernel:
$$ \pard{\wt{E}_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}
   =
    \left[ \vphantom{\wt{\vb E}\sup{des}}
           \,\, \boldsymbol{\delta}_i\sup{obj}\,\,
   \right]
   \star \bmc{G}\sup{EE} \star
   \left[-i\omega \wt{\vb E}\sup{des}\right]
$$
or
$$ \pard{\wt E_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}
   =-i\omega\VMV{ \boldsymbol{\delta}_i\sup{obj} }
                { \bmc G\sup{EE}                 }
                { \wt{\vb E}\sup{des}            }
$$
where <span><span class="MathJax_Preview">\star</span><script type="math/tex">\star</script></span> denotes convolution,
<span><span class="MathJax_Preview">\boldsymbol{\delta}_i\sup{obj}</span><script type="math/tex">\boldsymbol{\delta}_i\sup{obj}</script></span> is short for
<span><span class="MathJax_Preview">\delta_{ij} \delta(\vb{x}-\vb{x}\sup{obj}),</span><script type="math/tex">\delta_{ij} \delta(\vb{x}-\vb{x}\sup{obj}),</script></span>
and the bra-ket notation describes a machine that inputs two
vector-valued functions <span><span class="MathJax_Preview">\vb{f},\vb{g}</span><script type="math/tex">\vb{f},\vb{g}</script></span> and a kernel <span><span class="MathJax_Preview">\mc{K}</span><script type="math/tex">\mc{K}</script></span>
and outputs a scalar quantity:
$$ \VMV{\vb f}{\bmc K}{\vb g}
   \equiv \sum</em> \iint f_i(\vb{x})
                          \mc{K}_{ij}(\vb{x},\vb{x}^\prime)
                          g_j(\vb{x}^\prime)
                          \,d\vb{x} \,d\vb{x}^\prime
$$
(Note that this is not a Hermitian inner product, i.e. the first
factor is not conjugated.) </p>
<p>For the magnetic-field derivative we have similarly
$$ \pard{\wt{H}_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}
   =-i\omega\VMV{ \boldsymbol{\delta}_i\sup{obj} }
                { \boldsymbol{\mc G}\sup{ME}   }
                { \wt{\vb E}\sup{des}          }
$$
where <span><span class="MathJax_Preview">\bmc{G}\sup{ME}</span><script type="math/tex">\bmc{G}\sup{ME}</script></span> is the magnetic-electric
Green's function, giving the magnetic field produced 
by an electric current.</p>
<p>Computationally, inner products like
<span><span class="MathJax_Preview">\VMV{\vb f}{\bmc G\sup{EE}}{\vb g}</span><script type="math/tex">\VMV{\vb f}{\bmc G\sup{EE}}{\vb g}</script></span> 
for arbitrary functions <span><span class="MathJax_Preview">\vb{f}(\vb x), \vb{g}(\vb x)</span><script type="math/tex">\vb{f}(\vb x), \vb{g}(\vb x)</script></span>
may be evaluated in <span class=SC>meep</span>
as follows:</p>
<ol>
<li>
<p>Create an electric current source with
   spatially-varying amplitude <span><span class="MathJax_Preview">\vb{g}(\vb x)</span><script type="math/tex">\vb{g}(\vb x)</script></span>
   and Gaussian temporal envelope <span><span class="MathJax_Preview">G(t)</span><script type="math/tex">G(t)</script></span>.</p>
</li>
<li>
<p>Timestep and DFT to compute the frequency-domain electric field
   <span><span class="MathJax_Preview">\wt{\vb E}(\omega; \vb{x})</span><script type="math/tex">\wt{\vb E}(\omega; \vb{x})</script></span> produced by this source.</p>
</li>
<li>
<p>Compute the inner product
   <span><span class="MathJax_Preview">[\wt{G}(\omega)]^{-1}
    \int \vb{f}\cdot \wt{\vb E}\,dV.</span><script type="math/tex">[\wt{G}(\omega)]^{-1}
    \int \vb{f}\cdot \wt{\vb E}\,dV.</script></span>
   (The normalization prefactor was discussed above.)</p>
</li>
</ol>
<p>The virtue of writing things this way is that it allows the physical
property of reciprocity to be expressed as the mathematical property
that the aforementioned inner-product machine is insensitive to the
order of its arguments, i.e. we can flip the <span><span class="MathJax_Preview">\vb f</span><script type="math/tex">\vb f</script></span> and <span><span class="MathJax_Preview">\vb g</span><script type="math/tex">\vb g</script></span> 
inputs and still get the same scalar output:
$$ \VMV{\vb f}{\bmc K}{\vb g} = \VMV{\vb g}{\bmc K}{\vb f}
   \quad\text{ for }\quad \bmc K= \bmc{G}\sup{EE}, \bmc{G}\sup{ME}.
$$</p>
<p>Applying reciprocity to the above expressions for field derivatives yields
\begin{align<em>}
\pard{\wt E_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}
 &amp;=-i\omega\VMV{ \wt{\vb E }\sup{des}         }
               { \bmc{G}\sup{EE}              }
               { \boldsymbol{\delta}_i\sup{obj} }
 \tag{2}
\[5pt]
\pard{\wt H_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}
 &amp;=-i\omega\VMV{ \wt{\vb E }\sup{des}         }
               { \bmc{G}\sup{ME}              }
               { \boldsymbol{\delta}_i\sup{obj} }
 \tag{3a}
\
 \hphantom{\pard{\wt H_i(\vb{x}\sup{obj})}{\epsilon\sup{des}}}
  &amp;=+i\omega\VMV{ \wt{\vb E}\sup{des}          }
                { \bmc{G}\sup{EM}              }
                { \boldsymbol{\delta}_i\sup{obj} }
 \tag{3b}
\end{align</em>}
where in going to the last line we invoked the identity
<span><span class="MathJax_Preview">\bmc{G}\sup{EM}=-\bmc{G}\sup{ME}.</span><script type="math/tex">\bmc{G}\sup{EM}=-\bmc{G}\sup{ME}.</script></span></p>
<p>Note that equations (3a) and (3b), notwithstanding their nearly
identical appearance, describe two rather different
<span class=SC>meep</span> calculations: In the former case
we place an electric source at <span><span class="MathJax_Preview">\vb x\sup{obj}</span><script type="math/tex">\vb x\sup{obj}</script></span> and timestep to
compute the resulting magnetic field, while in the latter
case we place a magnetic source and timestep
to compute the resulting electric field. (In both cases,
upon computing the field in question we proceed to compute its
overlap with the unperturbed <span><span class="MathJax_Preview">\vb E</span><script type="math/tex">\vb E</script></span> field in the design region.)</p>
<h2 id="differentiating-more-complicated-functions-of-field-components">Differentiating more complicated functions of field components<a class="headerlink" href="#differentiating-more-complicated-functions-of-field-components" title="Permanent link">&para;</a></h2>
<p>Thus far we have only considered derivatives of individual
field components, and then only at a single point <span><span class="MathJax_Preview">\vb{x}\sup{obj}</span><script type="math/tex">\vb{x}\sup{obj}</script></span>;
more generally, we will want to differentiate functions of
multiple field components over a subregion of the grid,
which we will call the <em>objective region</em> <span><span class="MathJax_Preview">\mc{V}\sup{obj}</span><script type="math/tex">\mc{V}\sup{obj}</script></span>.</p>
<h3 id="e-field-energy-in-region"><strong>E</strong>-field energy in region<a class="headerlink" href="#e-field-energy-in-region" title="Permanent link">&para;</a></h3>
<p>As one example, the electric field energy in the objective
region is defined by an integral over that region, which <span class=SC>meep</span>
approximate by a weighted sum over grid points:
$$ \mc{E}=
   \frac{1}{2}\int_{\mc{V}\sup{obj}} \epsilon |\wt{\vb E}|^2 \,d\mc{V}
   \approx
   \frac{1}{2}\sum_{i,\vb{n}\in\mc{V}\sup{obj}} w_{\vb{n}}
   \epsilon_\vb {n} \wt E_{i\vb n}^* \wt E_{i\vb n}
$$
Here the sum is over all field components <span><span class="MathJax_Preview">i=\{x,y,z\}</span><script type="math/tex">i=\{x,y,z\}</script></span> and
all grid points <span><span class="MathJax_Preview">\vb{n}</span><script type="math/tex">\vb{n}</script></span> lying in <span><span class="MathJax_Preview">\mc{V}\sup{obj}</span><script type="math/tex">\mc{V}\sup{obj}</script></span>,
and <span><span class="MathJax_Preview">w_{\vb{n}}</span><script type="math/tex">w_{\vb{n}}</script></span> is a cubature weight associated with point <span><span class="MathJax_Preview">\vb{n}</span><script type="math/tex">\vb{n}</script></span>
(as returned by <a href="../../Python_User_Interface#metadata"><code>get_dft_array_metadata</code></a>).
Differentiating, we have
\begin{align<em>}
 \pard{\mc E}{\epsilon\sup{des}}
 &amp;=\text{Re }\sum_{i\vb{n}\in\mc V\sup{obj}} w_{\vb n}\epsilon_{\vb n}
   \wt{E}^</em><em i_vb="i\vb" n="n">{i\vb n} \pard{\wt{E}</em>} {\epsilon\sup{des}}
\
&amp;\hspace{-1.5in}\text{Insert equation (1a):}
\
 &amp;=\text{Re }\left{ -i\omega \VMV{\epsilon \wt{\vb E}\sup{obj<em>}}
                                   {{\bmc G}\sup{EE}}
                                   {\wt{\vb E}\sup{des}}
              \right}
\
&amp;\hspace{-1.5in}\text{Invoke reciprocity:}
\
 &amp;=\text{Re }\left{ -i\omega \VMV{\wt{\vb E}\sup{des}}
                                  {{\bmc G}\sup{EE}}
                                  {\epsilon \wt{\vb E}\sup{obj</em>}}
              \right}
\end{align*}</p>
<h3 id="poynting-flux">Poynting flux<a class="headerlink" href="#poynting-flux" title="Permanent link">&para;</a></h3>
<p>A case that arises frequently is that in which the objective region
is a cross-sectional surface <span><span class="MathJax_Preview">\mc S\sup{obj}</span><script type="math/tex">\mc S\sup{obj}</script></span> cutting normally through a
waveguide or similar structure and the objective function is the 
normal Poynting flux through <span><span class="MathJax_Preview">\mc S</span><script type="math/tex">\mc S</script></span>.
For example, the <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>-directed Poynting flux is given by
$$
 S_x
=
\frac{1}{2}\text{Re }\left{ \int_{\mc S\sup{obj}} \Big(E^<em><em S_sup_obj="S\sup{obj" _mc="\mc" _vb="\vb" n_in="n\in">y H_z + \cdots\Big) \, d\mathbf{x} \right}
\approx \frac{1}{2}\text{Re }\sum</em>} w_{\vb n}
 \Big(E^</em><em n="n" z_vb="z\vb">{y\vb n} H</em> + \cdots\Big)
$$
where <span><span class="MathJax_Preview">\cdots</span><script type="math/tex">\cdots</script></span> refers to three other terms of the form <span><span class="MathJax_Preview">\pm E^*_i H_j</span><script type="math/tex">\pm E^*_i H_j</script></span>.
Differentiating and rearranging slightly, we have
\begin{align<em>}
 \pard{S_x}{\epsilon\sup{des}}
 &amp;=\text{Re }\sum_{\vb n\in \mc S\sup{obj}} w
   \left{ \wt{E}^</em>_{y} \pard{\wt{H}_z}{\epsilon\sup{des}}
          +\wt{H}^<em><em y="y">{z} \pard{\wt{E}_y}{\epsilon\sup{des}}
         +\cdots
   \right}
\[5pt]
&amp;\hspace{-0.5in}\text{Use (1a) and (1b):}
\[5pt]
 &amp;=\text{Re }\left{ -i\omega \VMV{\wt{\vb E}</em>\sup{obj</em>}}
                                  {\bmc G\sup{ME}}
                                  {\wt{\vb E}\sup{des}}
                     -i\omega \VMV{\wt{\vb H}_z\sup{obj<em>}}
                                  {\bmc G\sup{EE}}
                                  {\wt{\vb E}\sup{des}}
                     +\cdots
            \right} 
\[5pt]
&amp;\hspace{-0.5in}\text{Use reciprocity:}
\[5pt]
&amp;=\text{Re }\left{ -i\omega  \VMV{\wt{\vb E}\sup{des}}
                                  {\bmc G\sup{ME}}
                                  {\wt{\vb E}_y\sup{obj</em>}}
                    -i\omega \VMV{\wt{\vb E}\sup{des}}
                                 {\bmc G\sup{EE}}
                                 {\wt{\vb H}_z\sup{obj<em>}}
                    +\cdots
              \right}
\end{align</em>}</p>
<h3 id="mode-coefficient">Mode coefficient<a class="headerlink" href="#mode-coefficient" title="Permanent link">&para;</a></h3>
<p>$$ \alpha_m^\pm = C_1 \pm C_2 $$
\begin{align<em>}
 C_1 &amp;=\frac{1}{\mathcal{N}}
   \int_{\mc S\sup{obj}} \Big(e^</em>_y H_z - e^<em><em S_sup_obj="S\sup{obj" _mc="\mc">z H_y\Big)d\mathbf{x}\
 C_2 &amp;=
   \frac{1}{\mathcal{N}}\int</em>} \Big(h^</em>_z E_y - h^<em>_y E_z\Big)d\mathbf{x}\
\end{align</em>}</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Visualization/" title="Visualization" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Visualization
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://yakworks.github.io/mkdocs-material-components/" title="Material Components for MkDocs">
          Material Components for MkDocs</a>
      </div>
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-68832431b5.js"></script>
      
      
      <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
      <script>window.mdc.autoInit()</script>
      <script src="../../assets/javascripts/headroom.min.js"></script>
      <script src="../../assets/javascripts/jQuery.headroom.min.js"></script>
      <script src="../../assets/javascripts/jq-mdc-web.js"></script>
      <script src="https://cdn.jsdelivr.net/jquery.loadingoverlay/latest/loadingoverlay.min.js"></script>
      <script>app.initialize({version:"0.16.3",url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
    
  </body>
</html>